Forgot Password Process & Workflow
==================================

This document explains, line by line, how the “Forgot Password” functionality works across the React frontend and Node/Express backend. It also summarizes the exact workflow a user request follows from the moment the email is submitted until a reset link is delivered.

Frontend: `frontend/src/users/pages/ForgotPassword.jsx`
-------------------------------------------------------
L1: import { useState } from "react"; // React hook to track component state (email + loading).
L2: import { Link } from "react-router-dom"; // Allows navigation back to the sign-in page without reloads.
L3: import axios from "axios"; // HTTP client used to call the backend API.
L4: import Navbar from "../../components/Navbar"; // Reusable top navigation bar.
L5: import Footer from "../../components/Footer"; // Reusable footer.
L6: import "../styles/login.css"; // Shared styling for auth-like pages.
L7: import { toast } from "react-toastify"; // Toast notifications for UX feedback.
L9: const ForgotPassword = () => { // Functional component definition.
L10:   const [email, setEmail] = useState(""); // Controlled input for the user’s email.
L11:   const [loading, setLoading] = useState(false); // Flag to disable the button and show spinner during API calls.
L13:   const handleSubmit = async (e) => { // Form submission handler.
L14:     e.preventDefault(); // Stops browser from reloading the page.
L15:     if (!email) return toast.error("Please enter your email"); // Client validation to avoid empty requests.
L17:     try {
L18:       setLoading(true); // Shows spinner, prevents double submissions.
L19:       await axios.post("http://localhost:5000/api/auth/forgot-password", { email }); // Sends email to backend API.
L20:       toast.success("If an account exists, reset instructions were sent"); // Same response for both existing and non-existing accounts for security.
L21:       setEmail(""); // Clears the input after submission.
L22:     } catch (error) {
L23:       toast.error(error.response?.data?.message || "Unable to process request"); // Displays error message from server or fallback text.
L24:     } finally {
L25:       setLoading(false); // Returns button to normal state.
L26:     }
L27:   };
L29:   return (
L31:       <Navbar /> // Renders site-wide navigation.
L32-65: Form markup: heading text, controlled email input, submit button showing spinner when `loading` is true, helper link back to sign-in, all using shared auth styles.
L70: export default ForgotPassword; // Makes the component available to routes.

Backend Route: `backend/routes/auth.js`
---------------------------------------
L1: import express from 'express'; // Express router factory.
L2: import { registerUser, loginUser, forgotPassword, resetPassword } from '../controller/authController.js'; // Brings in controller handlers, including forgotPassword.
L4: const router = express.Router(); // Creates a router instance.
L8: router.post('/forgot-password', forgotPassword); // Maps POST /api/auth/forgot-password to the controller.
L11: export default router; // Exposes routes to the main server.

Backend Controller: `backend/controller/authController.js`
----------------------------------------------------------
L1-8: Imports User model, bcrypt (for hashing), crypto (for secure tokens), JWT utilities, email service, and email templates. Crypto is pivotal to generating and hashing reset tokens.

Forgot Password handler (L64-110):
L65-71: Extracts `email` from the request body and returns HTTP 400 if it is missing.
L73-78: Attempts to find the user by email; regardless of result, ultimately respond with a success message to avoid revealing whether the email is registered.
L80-85: Generates a cryptographically secure random token (32 bytes), hashes it via SHA-256 for storage, and sets an expiry 15 minutes in the future before saving to MongoDB (skip validations with `validateBeforeSave: false`).
L87-89: Builds the reset link pointing to the frontend (`FRONTEND_URL` or localhost) with `token` and `email` encoded as query parameters so the Reset Password page can read them.
L90-101: Sends the email using the `passwordResetEmail` template. If email delivery fails, it clears the token fields to avoid dangling tokens and returns HTTP 500.
L104-105: Returns HTTP 200 with a generic success message (same as earlier to avoid user enumeration).
L107-109: Logs unexpected errors and responds with HTTP 500.

Email Template: `backend/utils/emailTemplates/passwordReset.js`
--------------------------------------------------------------
L1: import { baseTemplate } from "./baseTemplate.js"; // Provides shared branding/styling.
L3-27: `passwordResetEmail` accepts the user and reset link, then returns HTML that greets the user, explains the request, renders a styled “Reset Password” button pointing to the link, and reminds the user that the link expires in 15 minutes.

User Model Fields: `backend/models/User.js`
------------------------------------------
L54-61: Schema fields `passwordResetToken` and `passwordResetExpires` store the hashed token and expiry timestamp; both marked `select: false` so they don’t leak in normal queries.
L66-73: `pre('save')` hook automatically hashes the password with bcrypt when it changes. This matters later when the reset token is redeemed and a new password is stored.

Forgot Password Workflow (Step-by-Step)
---------------------------------------
1. User opens `/forgot-password`, enters their email, and submits the form. `handleSubmit` validates locally and sends a POST request with `{ email }`.
2. Express route `/api/auth/forgot-password` invokes `forgotPassword` in `authController`.
3. Controller validates the email, generates + hashes a reset token, saves it along with a 15-minute expiry on the user document, and constructs a frontend reset URL.
4. `sendEmail` delivers the `passwordResetEmail` HTML to the user. If email sending fails, stored token data is cleared and an error is returned; otherwise the API responds with a generic success message.
5. The frontend receives the success response and shows the toast “If an account exists, reset instructions were sent,” keeping timing identical whether the email exists or not.
6. (For completeness) When the user clicks the emailed link, the Reset Password page and `resetPassword` controller handle verifying the token and setting the new password, but those steps belong to the reset stage of the flow.

